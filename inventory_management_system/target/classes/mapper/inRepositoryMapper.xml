<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mo.mapper.InRepositoryMapper">
    <insert id="insertInRepository" parameterType="com.mo.pojo.InRepository">
        insert into in_repository(
        bid,
        material_id,
        quantity,
        unit_price,
        total_price,
        supplier_id,
        status,
        deliver_date,
        repository_id,
        create_by,
        create_time
        ) values(
        #{bid},
        #{material_id},
        #{quantity},
        #{unit_price},
        #{total_price},
        #{supplier_id},
        #{status},
        #{deliver_date},
        #{repository_id},
        #{create_by},
        now()
        )

    </insert>

    <insert id="insertMaterialRecord" parameterType="com.mo.pojo.MaterialRecord">
        insert into material_record(
        iid,
        mid,
        status,
        quantity,
        create_by,
        create_time
        ) values(
        #{iid},
        #{mid},
        #{status},
        #{quantity},
        #{create_by},
        now()
        )
    </insert>

    <update id="updateInRepository" parameterType="com.mo.pojo.InRepository">
        update in_repository set
        <if test="material_id !=null and material_id !=''">
            material_id = #{material_id},
        </if>
        <if test="quantity !=null and quantity !=''">
            quantity = #{quantity},
        </if>
        <if test="unit_price !=null and unit_price !=''">
            unit_price = #{unit_price},
        </if>
        <if test="supplier_id !=null and supplier_id !=''">
            supplier_id = #{supplier_id},
        </if>
        <if test="total_price !=null and total_price !=''">
            total_price = #{total_price},
        </if>
        <if test="status !=null and status !=0">
            status = #{status},
        </if>
        <if test="deliver_date !=null">
            deliver_date = #{deliver_date},
        </if>
        <if test="repository_id !=null and repository_id !=0">
            repository_id = #{repository_id},
        </if>
        modify_time=now(),
        modify_by=#{modify_by}
        where bid=#{bid}
    </update>

    <update id="updateMaterialQuantityOfTotalAndAvailable" parameterType="com.mo.pojo.Material">
        update material set
        <if test="name !=null and name !=''">
            name = #{name},
        </if>
        <if test="specification !=null and specification !=''">
            specification = #{specification},
        </if>
        <if test="color !=null and color !=''">
            color = #{color},
        </if>
        <if test="unit_price !=null">
            unit_price = #{unit_price},
        </if>
        <if test="position !=null and position !=''">
            position = #{position},
        </if>
        <if test="minimum_stock !=null">
            minimum_stock = #{minimum_stock},
        </if>
        <if test="unit !=null and unit !=''">
            unit = #{unit},
        </if>
        <if test="supplier_id !=null">
            supplier_id = #{supplier_id},
        </if>
        <if test="note !=null and note !=''">
            note = #{note},
        </if>
        <if test="total_quantity !=null and total_quantity !=0">
            total_quantity = #{total_quantity},
        </if>
        <if test="available_quantity !=null and available_quantity !=0">
            available_quantity = #{available_quantity},
        </if>
        <if test="frozen_quantity !=null and frozen_quantity !=0">
            frozen_quantity = #{frozen_quantity},
        </if>
        <if test="requisite_delivery_quantity !=null and requisite_delivery_quantity !=0">
            requisite_delivery_quantity = #{requisite_delivery_quantity},
        </if>
        modify_time=now(),
        modify_by=#{modify_by}
        where id=#{id}
    </update>

    <select id="findMaterialListByNameAndSupplier" resultType="com.mo.pojo.Material" parameterType="java.util.Map">

        select m.*,s.name as supplier_name from material m , supplier s
        where 1=1
        <if test="name !=null and name !=''">
            and m.name like concat(concat('%',#{name}),'%')
        </if>
        <if test="supplier_id !=null and supplier_id !=''">
            and m.supplier_id =#{supplier_id}
        </if>
        and m.supplier_id=s.id
        ORDER BY m.create_time desc limit #{start},10
    </select>

    <select id="findMaterialCountByNameAndSupplier" resultType="java.lang.Integer" parameterType="java.util.Map">

        select count(1) from material m
        where 1=1
        <if test="name !=null and name !=''">
            and m.name like concat(concat('%',#{name}),'%')
        </if>
        <if test="supplier_id !=null and supplier_id !=''">
            and m.supplier_id =#{supplier_id}
        </if>
    </select>

</mapper>